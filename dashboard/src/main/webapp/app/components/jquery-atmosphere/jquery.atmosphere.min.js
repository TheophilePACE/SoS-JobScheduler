/*
 * Copyright 2014 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere-javascript
 * 
 * Requires 
 * - jQuery 2.0.3 http://jquery.com/
 * 
 * API reference
 * https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 * 
 * Highly inspired by 
 * - Portal by Donghwan Kim http://flowersinthesand.github.io/portal/
 */
(function(d){"function"===typeof define&&define.amd?define(["jquery"],d):d(jQuery)})(function(d){d(window).bind("unload.atmosphere",function(){d.atmosphere.unsubscribe()});d(window).bind("offline",function(){d.atmosphere.unsubscribe()});d(window).keypress(function(d){27===d.keyCode&&d.preventDefault()});var fa=function(d){for(var l,h=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,r={};l=h.exec(d);)r[l[1]]=l[2];return r};d.atmosphere={version:"2.2.2-jquery",uuid:0,requests:[],callbacks:[],onError:function(d){},onClose:function(d){},
onOpen:function(d){},onMessage:function(d){},onReconnect:function(d,l){},onMessagePublished:function(d){},onTransportFailure:function(d,l){},onLocalMessage:function(d){},onClientTimeout:function(d){},onFailureToReconnect:function(d,l){},WebsocketApiAdapter:function(d){var l,h;d.onMessage=function(d){h.onmessage({data:d.responseBody})};d.onMessagePublished=function(d){h.onmessage({data:d.responseBody})};d.onOpen=function(d){h.onopen(d)};h={close:function(){l.close()},send:function(d){l.push(d)},onmessage:function(d){},
onopen:function(d){},onclose:function(d){},onerror:function(d){}};l=new $.atmosphere.subscribe(d);return h},AtmosphereRequest:function(k){function l(c){q();aa=!0;F=!1;A=0;C=K=y=p=null;e=d.extend(e,c);e.mrequest=e.reconnect;e.reconnect||(e.reconnect=!0)}function h(){if(e.shared){w=r(e);if(null!=w&&("debug"===e.logLevel&&d.atmosphere.debug("Storage service available. All communication will be local"),w.open(e)))return;"debug"===e.logLevel&&d.atmosphere.debug("No Storage service available.");w=null}e.firstMessage=
0==d.atmosphere.uuid?!0:!1;e.isOpen=!1;e.ctime=d.now();0===e.uuid&&(e.uuid=d.atmosphere.uuid);e.closedByClientTimeout=!1;"websocket"!==e.transport&&"sse"!==e.transport?W(e):"websocket"===e.transport?null!=e.webSocketImpl||window.WebSocket||window.MozWebSocket?m(!1):L("Websocket is not supported, using request.fallbackTransport ("+e.fallbackTransport+")"):"sse"===e.transport&&(window.EventSource?t(!1):L("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+e.fallbackTransport+
")"))}function r(c){function a(a){a=d.parseJSON(a);var g=a.data;if("c"===a.target)switch(a.type){case "open":n("opening","local",e);break;case "close":ba||(ba=!0,"aborted"===g.reason?O():g.heir===G?h():setTimeout(function(){h()},100));break;case "message":H(g,"messageReceived",200,c.transport);break;case "localMessage":ga(g)}}function f(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(s)+")=([^;]*)")).exec(document.cookie);if(a)return d.parseJSON(decodeURIComponent(a[2]))}var g,M,ba,s="atmosphere-"+
c.url,k={storage:function(){if(d.atmosphere.supportStorage()){var e=window.localStorage,g=function(a){return d.parseJSON(e.getItem(s+"-"+a))},f=function(a,c){e.setItem(s+"-"+a,d.stringifyJSON(c))};return{init:function(){f("children",g("children").concat([G]));d(window).on("storage.socket",function(c){c=c.originalEvent;c.key===s&&c.newValue&&a(c.newValue)});return g("opened")},signal:function(a,c){e.setItem(s,d.stringifyJSON({target:"p",type:a,data:c}))},close:function(){var a,e=g("children");d(window).off("storage.socket");
e&&(a=d.inArray(c.id,e),-1<a&&(e.splice(a,1),f("children",e)))}}}},windowref:function(){var c=window.open("",s.replace(/\W/g,""));if(c&&!c.closed&&c.callbacks)return{init:function(){c.callbacks.push(a);c.children.push(G);return c.opened},signal:function(a,e){!c.closed&&c.fire&&c.fire(d.stringifyJSON({target:"p",type:a,data:e}))},close:function(){if(!ba){var e=c.callbacks,g=d.inArray(a,e);-1<g&&e.splice(g,1);e=c.children;g=d.inArray(G,e);-1<g&&e.splice(g,1)}}}}};if((g=f())&&!(1E3<d.now()-g.ts)&&(M=
k.storage()||k.windowref()))return{open:function(){var e;X=setInterval(function(){var c=g;(g=f())&&c.ts!==g.ts||a(d.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:c.heir}}))},1E3);(e=M.init())&&setTimeout(function(){n("opening","local",c)},50);return e},send:function(a){M.signal("send",a)},localSend:function(a){M.signal("localSend",d.stringifyJSON({id:G,event:a}))},close:function(){F||(clearInterval(X),M.signal("close"),M.close())}}}function P(){function c(a){a=d.parseJSON(a);var c=
a.data;if("p"===a.target)switch(a.type){case "send":Q(c);break;case "localSend":ga(c);break;case "close":O()}}function a(){document.cookie=ca+"="+encodeURIComponent(d.stringifyJSON({ts:d.now()+1,heir:(f.get("children")||[])[0]}))+"; path=/"}var f,g="atmosphere-"+e.url,h={storage:function(){if(d.atmosphere.supportStorage()){var a=window.localStorage;return{init:function(){d(window).on("storage.socket",function(a){a=a.originalEvent;a.key===g&&a.newValue&&c(a.newValue)})},signal:function(c,e){a.setItem(g,
d.stringifyJSON({target:"c",type:c,data:e}))},get:function(c){return d.parseJSON(a.getItem(g+"-"+c))},set:function(c,e){a.setItem(g+"-"+c,d.stringifyJSON(e))},close:function(){d(window).off("storage.socket");a.removeItem(g);a.removeItem(g+"-opened");a.removeItem(g+"-children")}}}},windowref:function(){var a=g.replace(/\W/g,""),e=(d('iframe[name="'+a+'"]')[0]||d('<iframe name="'+a+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){e.callbacks=[c];e.fire=function(a){var c;for(c=
0;c<e.callbacks.length;c++)e.callbacks[c](a)}},signal:function(a,c){!e.closed&&e.fire&&e.fire(d.stringifyJSON({target:"c",type:a,data:c}))},get:function(a){return e.closed?null:e[a]},set:function(a,c){e.closed||(e[a]=c)},close:function(){}}}};R=function(a){f.signal("message",a)};f=h.storage()||h.windowref();f.init();"debug"===e.logLevel&&d.atmosphere.debug("Installed StorageService "+f);f.set("children",[]);null==f.get("opened")||f.get("opened")||f.set("opened",!1);ca=encodeURIComponent(g);a();X=
setInterval(a,1E3);D=f}function n(c,a,d){e.shared&&"local"!==a&&P();null!=D&&D.set("opened",!0);d.close=function(){O()};0<A&&"re-connecting"===c?(d.isReopen=!0,qa(f)):null==f.error&&(f.request=d,d=f.state,f.state=c,c=f.transport,f.transport=a,a=f.responseBody,x(),f.responseBody=a,f.state=d,f.transport=c)}function ha(c){c.transport="jsonp";var a=e;null!=c&&"undefined"!==typeof c&&(a=c);c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var z=a.data;a.attachHeadersAsQueryString&&(c=J(a),""!==z&&(c+="&X-Atmosphere-Post-Body="+
encodeURIComponent(z)),z="");u=d.ajax({url:c,type:a.method,dataType:"jsonp",error:function(c,e,d){f.error=!0;a.openId&&clearTimeout(a.openId);a.heartbeatTimer&&clearTimeout(a.heartbeatTimer);a.reconnect&&A++<a.maxReconnectOnClose?(n("re-connecting",a.transport,a),B(u,a,a.reconnectInterval),a.openId=setTimeout(function(){S(a)},a.reconnectInterval+1E3)):v(c.status,d)},jsonp:"jsonpTransport",success:function(c){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){Y(u,a);a.executeCallbackBeforeReconnect||
B(u,a,a.pollingInterval);c=c.message;if(null!=c&&"string"!==typeof c)try{c=d.stringifyJSON(c)}catch(z){}E(c,a,f)||H(f.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&B(u,a,a.pollingInterval)}else d.atmosphere.log(e.logLevel,["JSONP reconnect maximum try reached "+e.requestCount]),v(0,"maxRequest reached")},data:a.data,beforeSend:function(c){da(c,a,!1)}})}function ra(c){var a=e;null!=c&&"undefined"!==typeof c&&(a=c);c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);
var z=a.data;a.attachHeadersAsQueryString&&(c=J(a),""!==z&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(z)),z="");u=d.ajax({url:c,type:a.method,error:function(c,e,d){f.error=!0;300>c.status?B(u,a):v(c.status,d)},success:function(c,z,h){a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest?(a.executeCallbackBeforeReconnect||B(u,a,a.pollingInterval),E(c,a,f)||H(f.responseBody,"messageReceived",200,a.transport),a.executeCallbackBeforeReconnect&&B(u,a,a.pollingInterval)):(d.atmosphere.log(e.logLevel,
["AJAX reconnect maximum try reached "+e.requestCount]),v(0,"maxRequest reached")))},beforeSend:function(c){da(c,a,!1)},crossDomain:a.enableXDR,async:"undefined"!==typeof a.async?a.async:!0})}function sa(c){return null!=e.webSocketImpl?e.webSocketImpl:window.WebSocket?new WebSocket(c):new MozWebSocket(c)}function N(){var c=J(e);return decodeURI(d('<a href="'+c+'"/>')[0].href.replace(/^http/,"ws"))}function t(c){f.transport="sse";var a=J(e);"debug"===e.logLevel&&(d.atmosphere.debug("Invoking executeSSE"),
d.atmosphere.debug("Using URL: "+a));if(c&&!e.reconnect)null!=y&&q();else{try{y=new EventSource(a,{withCredentials:e.withCredentials})}catch(z){v(0,z);L("SSE failed. Downgrading to fallback transport and resending");return}0<e.connectTimeout&&(e.id=setTimeout(function(){c||q()},e.connectTimeout));y.onopen=function(a){I(e);"debug"===e.logLevel&&d.atmosphere.debug("SSE successfully opened");e.enableProtocol?e.isReopen&&(e.isReopen=!1,n("re-opening",e.transport,e)):c?n("re-opening","sse",e):n("opening",
"sse",e);c=!0;"POST"===e.method&&(f.state="messageReceived",y.send(e.data))};y.onmessage=function(a){I(e);e.enableXDR||a.origin===window.location.protocol+"//"+window.location.host?(f.state="messageReceived",f.status=200,a=a.data,E(a,e,f)||(x(),f.responseBody="",f.messages=[])):d.atmosphere.log(e.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host])};y.onerror=function(a){clearTimeout(e.id);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);f.closedByClientTimeout||((T(c),
q(),F)?d.atmosphere.log(e.logLevel,["SSE closed normally"]):c?e.reconnect&&"sse"===f.transport&&(A++<e.maxReconnectOnClose?(n("re-connecting",e.transport,e),0<e.reconnectInterval?e.reconnectId=setTimeout(function(){t(!0)},e.reconnectInterval):t(!0),f.responseBody="",f.messages=[]):(d.atmosphere.log(e.logLevel,["SSE reconnect maximum try reached "+A]),v(0,"maxReconnectOnClose reached"))):L("SSE failed. Downgrading to fallback transport and resending"))}}}function m(c){f.transport="websocket";var a=
N(e.url);"debug"===e.logLevel&&(d.atmosphere.debug("Invoking executeWebSocket"),d.atmosphere.debug("Using URL: "+a));if(c&&!e.reconnect)null!=p&&q();else if(p=sa(a),null!=e.webSocketBinaryType&&(p.binaryType=e.webSocketBinaryType),0<e.connectTimeout&&(e.id=setTimeout(function(){if(!c){p.onclose({code:1002,reason:"",wasClean:!1});try{q()}catch(a){}}},e.connectTimeout)),p.onopen=function(a){I(e);"debug"===e.logLevel&&d.atmosphere.debug("Websocket successfully opened");a=c;null!=p&&(p.canSendMessage=
!0);e.enableProtocol||(c=!0,a?n("re-opening","websocket",e):n("opening","websocket",e));null!=p&&"POST"===e.method&&(f.state="messageReceived",p.send(e.data))},p.onmessage=function(a){I(e);e.enableProtocol&&(c=!0);f.state="messageReceived";f.status=200;a=a.data;"string"===typeof a?E(a,e,f)||(x(),f.responseBody="",f.messages=[]):(a=ia(e,a),""!==a&&(f.responseBody=a,x(),f.responseBody=null))},p.onerror=function(a){clearTimeout(e.id);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer)},p.onclose=function(a){if("closed"!==
f.state){clearTimeout(e.id);var g=a.reason;if(""===g)switch(a.code){case 1E3:g="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:g="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:g="The endpoint is terminating the connection due to a protocol error.";break;case 1003:g="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";
break;case 1004:g="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:g="Unknown: no status code was provided even though one was expected.";break;case 1006:g="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===e.logLevel&&(d.atmosphere.warn("Websocket closed, reason: "+g),d.atmosphere.warn("Websocket closed, wasClean: "+a.wasClean));f.closedByClientTimeout||((T(c),f.state="closed",F)?d.atmosphere.log(e.logLevel,
["Websocket closed normally"]):c?e.reconnect&&"websocket"===f.transport&&1001!==a.code&&(q(),A++<e.maxReconnectOnClose?(n("re-connecting",e.transport,e),0<e.reconnectInterval?e.reconnectId=setTimeout(function(){f.responseBody="";f.messages=[];m(!0)},e.reconnectInterval):(f.responseBody="",f.messages=[],m(!0))):(d.atmosphere.log(e.logLevel,["Websocket reconnect maximum try reached "+e.requestCount]),"warn"===e.logLevel&&d.atmosphere.warn("Websocket error, reason: "+a.reason),v(0,"maxReconnectOnClose reached"))):
L("Websocket failed. Downgrading to Comet and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===p.url)p.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ia(c,a){var f=a;if("polling"===c.transport)return f;if(0!==d.trim(a).length&&c.enableProtocol&&c.firstMessage){var g=c.trackMessageLength?1:0,h=a.split(c.messageDelimiter);if(h.length<=g+1)return f;c.firstMessage=!1;c.uuid=d.trim(h[g]);h.length<=g+2&&d.atmosphere.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]);
var k=parseInt(d.trim(h[g+1]),10),l=h[g+2];if(!isNaN(k)&&0<k){var m=function(){Q(l);c.heartbeatTimer=setTimeout(m,k)};c.heartbeatTimer=setTimeout(m,k)}b=!1;"long-polling"!==c.transport&&S(c);d.atmosphere.uuid=c.uuid;f="";g=c.trackMessageLength?4:3;if(h.length>g+1)for(;g<h.length;g++)f+=h[g],g+1!==h.length&&(f+=c.messageDelimiter);0!==c.ackInterval&&setTimeout(function(){Q("...ACK...")},c.ackInterval)}else c.enableProtocol&&c.firstMessage&&d.browser.msie&&10>+d.browser.version.split(".")[0]?d.atmosphere.log(e.logLevel,
["Receiving unexpected data from IE"]):S(c);return f}function I(c){clearTimeout(c.id);0<c.timeout&&"polling"!==c.transport&&(c.id=setTimeout(function(){f.closedByClientTimeout=!0;f.state="closedByClient";f.responseBody="";f.status=408;f.messages=[];x();ea();q()},c.timeout))}function v(c,a){q();clearTimeout(e.id);f.state="error";f.reasonPhrase=a;f.responseBody="";f.status=c;f.messages=[];x()}function E(c,a,e){c=ia(a,c);if(0===c.length)return!0;e.responseBody=c;if(a.trackMessageLength){c=e.partialMessage+
c;for(var d=[],f=c.indexOf(a.messageDelimiter);-1!==f;){var h=c.substring(0,f),k=parseInt(h,10);if(isNaN(k))throw'message length "'+h+'" is not a number';f+=a.messageDelimiter.length;f+k>c.length?f=-1:(d.push(c.substring(f,f+k)),c=c.substring(f+k,c.length),f=c.indexOf(a.messageDelimiter))}e.partialMessage=c;if(0!==d.length)e.responseBody=d.join(a.messageDelimiter),e.messages=d;else return e.responseBody="",e.messages=[],!0}else e.responseBody=c;return!1}function L(c){d.atmosphere.log(e.logLevel,[c]);
if("undefined"!==typeof e.onTransportFailure)e.onTransportFailure(c,e);else if("undefined"!==typeof d.atmosphere.onTransportFailure)d.atmosphere.onTransportFailure(c,e);e.transport=e.fallbackTransport;c=-1===e.connectTimeout?0:e.connectTimeout;e.reconnect&&"none"!==e.transport||null==e.transport?(e.method=e.fallbackMethod,f.transport=e.fallbackTransport,e.fallbackTransport="none",0<c?e.reconnectId=setTimeout(function(){h()},c):h()):v(500,"Unable to reconnect with fallback transport")}function J(c,
a){var h=e;null!=c&&"undefined"!==typeof c&&(h=c);null==a&&(a=h.url);if(!h.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+h.uuid;a+="&X-Atmosphere-Framework="+d.atmosphere.version;a+="&X-Atmosphere-Transport="+h.transport;h.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");null!==h.heartbeat&&null!==h.heartbeat.server&&(a+="&X-Heartbeat-Server="+h.heartbeat.server);""!==h.contentType&&(a+="&Content-Type="+
("websocket"===h.transport?h.contentType:encodeURIComponent(h.contentType)));h.enableProtocol&&(a+="&X-atmo-protocol=true");d.each(h.headers,function(e,k){var l=d.isFunction(k)?k.call(this,h,c,f):k;null!=l&&(a+="&"+encodeURIComponent(e)+"="+encodeURIComponent(l))});return a}function S(c){c.isOpen?c.isReopen&&(c.isReopen=!1,n("re-opening",c.transport,c)):(c.isOpen=!0,n("opening",c.transport,c))}function W(c){var a=e;if(null!=c||"undefined"!==typeof c)a=c;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||
a.enableXDR&&d.atmosphere.checkCORSSupport())ha(a);else if("ajax"===a.transport)ra(c);else{if(d.browser.msie&&10>+d.browser.version.split(".")[0]){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?U(a):V(a);return}if(a.enableXDR&&window.XDomainRequest){U(a);return}}var h=function(){a.lastIndex=0;a.reconnect&&A++<a.maxReconnectOnClose?(n("re-connecting",c.transport,c),B(g,a,c.reconnectInterval)):v(0,"maxReconnectOnClose reached")};if(a.reconnect&&(-1===a.maxRequest||a.requestCount++<
a.maxRequest)){var g=d.ajaxSettings.xhr();g.hasData=!1;da(g,a,!0);a.suspend&&(K=g);"polling"!==a.transport&&(f.transport=a.transport,g.onabort=function(){T(!0)},g.onerror=function(){f.error=!0;f.ffTryingReconnect=!0;try{f.status=XMLHttpRequest.status}catch(a){f.status=500}f.status||(f.status=500);f.errorHandled||(q(),h())});g.onreadystatechange=function(){if(!F){f.error=null;var k=!1,l=!1;if("streaming"===a.transport&&2<a.readyState&&4===g.readyState)q(),h();else{a.readyState=g.readyState;"streaming"===
a.transport&&3<=g.readyState?l=!0:"long-polling"===a.transport&&4===g.readyState&&(l=!0);I(e);if("polling"!==a.transport){var s=200;4===g.readyState&&(s=1E3<g.status?0:g.status);if(300<=s||0===s){f.errorHandled=!0;q();h();return}a.enableProtocol&&c.firstMessage||2!==g.readyState||(d.browser.mozilla&&f.ffTryingReconnect?(f.ffTryingReconnect=!1,setTimeout(function(){f.ffTryingReconnect||S(a)},500)):S(a))}else 4===g.readyState&&(l=!0);if(l)if(l=g.responseText,0===d.trim(l).length&&"long-polling"===a.transport)g.hasData?
g.hasData=!1:(f.errorHandled=!0,q(),h());else{g.hasData=!0;Y(g,e);if("streaming"===a.transport)if(d.browser.opera)d.atmosphere.iterate(function(){if(500!==f.status&&g.responseText.length>a.lastIndex){try{f.status=g.status,f.headers=fa(g.getAllResponseHeaders()),Y(g,e)}catch(c){f.status=404}I(e);f.state="messageReceived";var d=g.responseText.substring(a.lastIndex);a.lastIndex=g.responseText.length;(k=E(d,a,f))||x();ja(g,a)&&ka(g,a)}else if(400<f.status)return a.lastIndex=g.responseText.length,!1},
0);else{if(s=l.substring(a.lastIndex,l.length),k=E(s,a,f),a.lastIndex=l.length,k)return}else k=E(l,a,f);l=ja(g,a);try{f.status=g.status,f.headers=fa(g.getAllResponseHeaders()),Y(g,a)}catch(m){f.status=404}f.state=a.suspend?0===f.status?"closed":"messageReceived":"messagePublished";(s=!l&&"streaming"!==c.transport&&"polling"!==c.transport)&&!a.executeCallbackBeforeReconnect&&B(g,a,a.pollingInterval);0===f.responseBody.length||k||x();s&&a.executeCallbackBeforeReconnect&&B(g,a,a.pollingInterval);l&&
ka(g,a)}}}};g.send(a.data);aa=!0}else"debug"===a.logLevel&&d.atmosphere.log(a.logLevel,["Max re-connection reached."]),v(0,"maxRequest reached")}}function ka(c,a){O();F=!1;B(c,a,500)}function da(c,a,h){var g=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(g+=a.dispatchUrl);g=J(a,g);g=d.atmosphere.prepareURL(g);h&&(c.open(a.method,g,!0),0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(q(),H("Connect timeout","closed",200,a.transport))},a.connectTimeout)));e.withCredentials&&"websocket"!==
e.transport&&"withCredentials"in c&&(c.withCredentials=!0);e.dropHeaders||(c.setRequestHeader("X-Atmosphere-Framework",d.atmosphere.version),c.setRequestHeader("X-Atmosphere-Transport",a.transport),null!==c.heartbeat&&null!==c.heartbeat.server&&c.setRequestHeader("X-Heartbeat-Server",c.heartbeat.server),a.trackMessageLength&&c.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),c.setRequestHeader("X-Atmosphere-tracking-id",a.uuid),d.each(a.headers,function(e,g){var k=d.isFunction(g)?g.call(this,
c,a,h,f):g;null!=k&&c.setRequestHeader(e,k)}));""!==a.contentType&&c.setRequestHeader("Content-Type",a.contentType)}function B(c,a,d){if(a.reconnect||a.suspend&&aa){var g=0;1<c.readyState&&(g=1E3<c.status?0:c.status);f.status=0===g?204:g;f.reason=0===g?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.reconnectId&&(clearTimeout(a.reconnectId),delete a.reconnectId);0<d?setTimeout(function(){e.reconnectId=W(a)},d):W(a)}}function qa(c){c.state="re-connecting";la(c)}function U(c){"polling"!==
c.transport?(C=ma(c),C.open()):ma(c).open()}function ma(c){var a=e;null!=c&&"undefined"!==typeof c&&(a=c);var h=a.transport,g=0,k=new window.XDomainRequest,l=function(){"long-polling"===a.transport&&a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)&&(k.status=200,U(a))},m=a.rewriteURL||function(a){var c=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(c&&c[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+c[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,
"?PHPSESSID="+c[2]+"&").replace(/&$/,"")}return a};k.onprogress=function(){clearTimeout(a.id);var c=k.responseText,c=c.substring(g);g+=c.length;if("polling"!==h){I(a);var e=E(c,a,f);if("long-polling"!==h||0!==d.trim(c).length)a.executeCallbackBeforeReconnect&&l(),e||H(f.responseBody,"messageReceived",200,h),a.executeCallbackBeforeReconnect||l()}};k.onerror=function(){"polling"!==a.transport&&(q(),A++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){n("re-connecting",
c.transport,c);U(a)},a.reconnectInterval):(n("re-connecting",c.transport,c),U(a)):v(0,"maxReconnectOnClose reached"))};k.onload=function(){};return{open:function(){var c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);c=J(a,c);k.open(a.method,m(c));"GET"===a.method?k.send():k.send(a.data);0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(q(),H("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){k.abort()}}}function V(c){C=ta(c);C.open()}function ta(c){var a=
e;null!=c&&"undefined"!==typeof c&&(a=c);var h,g=new window.ActiveXObject("htmlfile");g.open();g.close();var k=a.url;null!=a.dispatchUrl&&(k+=a.dispatchUrl);"polling"!==a.transport&&(f.transport=a.transport);return{open:function(){var c=g.createElement("iframe");k=J(a);""!==a.data&&(k+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));k=d.atmosphere.prepareURL(k);c.src=k;g.body.appendChild(c);var l=c.contentDocument||c.contentWindow.document;h=d.atmosphere.iterate(function(){try{if(l.firstChild){if("complete"===
l.readyState)try{d.noop(l.fileSize)}catch(c){return H("Connection Failure","error",500,a.transport),!1}var k=l.body?l.body.lastChild:l,m=function(){var a=k.cloneNode(!0);a.appendChild(l.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!d.nodeName(k,"pre")){var p=l.head||l.getElementsByTagName("head")[0]||l.documentElement||l,q=l.createElement("script");q.text="document.write('<plaintext>')";p.insertBefore(q,p.firstChild);p.removeChild(q);k=l.body.lastChild}a.closed&&(a.isReopen=
!0);h=d.atmosphere.iterate(function(){var c=m();if(c.length>a.lastIndex){I(e);f.status=200;f.error=null;k.innerText="";if(E(c,a,f))return"";H(f.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===l.readyState)return T(!0),n("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){V(a)},a.reconnectInterval):V(a),!1},null);return!1}}catch(r){return f.error=!0,n("re-connecting",a.transport,a),A++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=
setTimeout(function(){V(a)},a.reconnectInterval):V(a):v(0,"maxReconnectOnClose reached"),g.execCommand("Stop"),g.close(),!1}})},close:function(){h&&h();g.execCommand("Stop");T(!0)}}}function Q(c){null!=w?w.send(c):null!=K||null!=y?Z(c):null!=C?e.enableXDR&&d.atmosphere.checkCORSSupport()?(c=na(c),c.reconnect=!1,ha(c)):Z(c):null!=u?Z(c):null!=p?ua(c):(v(0,"No suspended connection available"),d.atmosphere.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}
function Z(c){c=na(c);W(c)}function oa(c){var a=c;"object"===typeof a&&(a=c.data);return a}function na(c){var a=oa(c),a={connected:!1,timeout:6E4,method:"POST",url:e.url,contentType:e.contentType,headers:e.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:e.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:e.enableXDR,uuid:e.uuid,dispatchUrl:e.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:e.trackMessageLength,
maxReconnectOnClose:e.maxReconnectOnClose,heartbeatTimer:e.heartbeatTimer,heartbeat:e.heartbeat};"object"===typeof c&&(a=d.extend(a,c));return a}function ua(c){var a=d.atmosphere.isBinary(c)?c:oa(c),f;try{f=null!=e.dispatchUrl?e.webSocketPathDelimiter+e.dispatchUrl+e.webSocketPathDelimiter+a:a,p.canSendMessage?p.send(f):d.atmosphere.error("WebSocket not connected.")}catch(g){p.onclose=function(a){},q(),L("Websocket failed. Downgrading to Comet and resending "+c),Z(c)}}function ga(c){c=d.parseJSON(c);
if(c.id!==G)if("undefined"!==typeof e.onLocalMessage)e.onLocalMessage(c.event);else if("undefined"!==typeof d.atmosphere.onLocalMessage)d.atmosphere.onLocalMessage(c.event)}function H(c,a,e,d){f.responseBody=c;f.transport=d;f.status=e;f.state=a;x()}function Y(c,a){if(a.readResponsesHeaders)try{var e=c.getResponseHeader("X-Atmosphere-tracking-id");e&&null!=e&&(a.uuid=e.split(" ").pop())}catch(f){}else a.enableProtocol||(a.uuid=d.atmosphere.guid())}function la(c){pa(c,e);pa(c,d.atmosphere)}function pa(c,
a){switch(c.state){case "messageReceived":A=0;if("undefined"!==typeof a.onMessage)a.onMessage(c);break;case "error":if("undefined"!==typeof a.onError)a.onError(c);break;case "opening":delete e.closed;if("undefined"!==typeof a.onOpen)a.onOpen(c);break;case "messagePublished":if("undefined"!==typeof a.onMessagePublished)a.onMessagePublished(c);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(e,c);break;case "closedByClient":if("undefined"!==typeof a.onClientTimeout)a.onClientTimeout(e);
break;case "re-opening":delete e.closed;if("undefined"!==typeof a.onReopen)a.onReopen(e,c);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(e,c);break;case "unsubscribe":case "closed":if(("undefined"===typeof e.closed||!e.closed)&&"undefined"!==typeof a.onClose)a.onClose(c);e.closed=!0}}function T(c){"closed"!==f.state&&(f.state="closed",f.responseBody="",f.messages=[],f.status=c?200:501,x())}function x(){var c=function(a,c){c(f)};null==w&&null!=
R&&R(f.responseBody);e.reconnect=e.mrequest;for(var a="string"===typeof f.responseBody,h=a&&e.trackMessageLength?0<f.messages.length?f.messages:[""]:Array(f.responseBody),g=0;g<h.length;g++)if(!(1<h.length&&0===h[g].length)&&(f.responseBody=a?d.trim(h[g]):h[g],null==w&&null!=R&&R(f.responseBody),0!==f.responseBody.length||"messageReceived"!==f.state)){la(f);if(0<d.atmosphere.callbacks.length){"debug"===e.logLevel&&d.atmosphere.debug("Invoking "+d.atmosphere.callbacks.length+" global callbacks: "+
f.state);try{d.each(d.atmosphere.callbacks,c)}catch(k){d.atmosphere.log(e.logLevel,["Callback exception"+k])}}if("function"===typeof e.callback){"debug"===e.logLevel&&d.atmosphere.debug("Invoking request callbacks");try{e.callback(f)}catch(l){d.atmosphere.log(e.logLevel,["Callback exception"+l])}}}}function ja(c,a){return""===f.partialMessage&&"streaming"===a.transport&&c.responseText.length>a.maxStreamingLength?!0:!1}function ea(){if(e.enableProtocol&&!e.firstMessage){var c="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+
e.uuid;d.each(e.headers,function(a,h){var k=d.isFunction(h)?h.call(this,e,e,f):h;null!=k&&(c+="&"+encodeURIComponent(a)+"="+encodeURIComponent(k))});var a=e.url.replace(/([?&])_=[^&]*/,c),a=a+(a===e.url?(/\?/.test(e.url)?"&":"?")+c:"");0<e.connectTimeout?d.ajax({url:a,async:!1,timeout:e.connectTimeout,cache:!1}):d.ajax({url:a,async:!1,cache:!1})}}function O(){e.reconnectId&&(clearTimeout(e.reconnectId),delete e.reconnectId);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);e.reconnect=!1;F=!0;f.request=
e;f.state="unsubscribe";f.responseBody="";f.status=408;x();ea();q()}function q(){f.partialMessage="";e.id&&clearTimeout(e.id);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);null!=C&&(C.close(),C=null);null!=u&&(u.abort(),u=null);null!=K&&(K.abort(),K=null);null!=p&&(p.canSendMessage&&p.close(),p=null);null!=y&&(y.close(),y=null);null!=D&&(clearInterval(X),document.cookie=ca+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",D.signal("close",{reason:"",heir:F?(D.get("children")||[])[0]:G}),D.close());
null!=w&&w.close()}var e={timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,
messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,onError:function(c){},onClose:function(c){},onOpen:function(c){},onMessage:function(c){},onReopen:function(c,a){},onReconnect:function(c,a){},onMessagePublished:function(c){},onTransportFailure:function(c,a){},onLocalMessage:function(c){},onFailureToReconnect:function(c,a){},onClientTimeout:function(c){}},
f={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},p=null,y=null,K=null,C=null,u=null,aa=!0,A=0,F=!1,R=null,D,w=null,G=d.now(),X,ca;l(k);this.subscribe=function(c){l(c);h()};this.execute=function(){h()};this.invokeCallback=function(){x()};this.close=function(){O()};this.disconnect=function(){ea()};this.getUrl=function(){return e.url};
this.push=function(c,a){if(null!=a){var d=e.dispatchUrl;e.dispatchUrl=a;Q(c);e.dispatchUrl=d}else Q(c)};this.getUUID=function(){return e.uuid};this.pushLocal=function(c){if(0!==c.length)try{w?w.localSend(c):D&&D.signal("localMessage",d.stringifyJSON({id:G,event:c}))}catch(a){d.atmosphere.error(a)}};this.enableProtocol=function(c){return e.enableProtocol};this.request=e;this.response=f},subscribe:function(k,l,h){"function"===typeof l&&d.atmosphere.addCallback(l);"string"!==typeof k?h=k:h.url=k;d.atmosphere.uuid=
"undefined"!==typeof h&&"undefined"!==typeof h.uuid?h.uuid:0;k=new d.atmosphere.AtmosphereRequest(h);k.execute();return d.atmosphere.requests[d.atmosphere.requests.length]=k},addCallback:function(k){-1===d.inArray(k,d.atmosphere.callbacks)&&d.atmosphere.callbacks.push(k)},removeCallback:function(k){k=d.inArray(k,d.atmosphere.callbacks);-1!==k&&d.atmosphere.callbacks.splice(k,1)},unsubscribe:function(){if(0<d.atmosphere.requests.length)for(var k=[].concat(d.atmosphere.requests),l=0;l<k.length;l++){var h=
k[l];h.close();clearTimeout(h.response.request.id);h.heartbeatTimer&&clearTimeout(h.heartbeatTimer)}d.atmosphere.requests=[];d.atmosphere.callbacks=[]},unsubscribeUrl:function(k){var l=-1;if(0<d.atmosphere.requests.length)for(var h=0;h<d.atmosphere.requests.length;h++){var r=d.atmosphere.requests[h];if(r.getUrl()===k){r.close();clearTimeout(r.response.request.id);r.heartbeatTimer&&clearTimeout(r.heartbeatTimer);l=h;break}}0<=l&&d.atmosphere.requests.splice(l,1)},publish:function(k){"function"===typeof k.callback&&
d.atmosphere.addCallback(k.callback);k.transport="polling";k=new d.atmosphere.AtmosphereRequest(k);return d.atmosphere.requests[d.atmosphere.requests.length]=k},checkCORSSupport:function(){return d.browser.msie&&!window.XDomainRequest&&11>+d.browser.version.split(".")[0]||d.browser.opera&&12>+d.browser.version.split(".")[0]||"KreaTVWebKit/531"===d.trim(navigator.userAgent).slice(0,16)||"kreatel"===d.trim(navigator.userAgent).slice(-7).toLowerCase()?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?
!0:!1},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return d.atmosphere.S4()+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+d.atmosphere.S4()+d.atmosphere.S4()},prepareURL:function(k){var l=d.now(),h=k.replace(/([?&])_=[^&]*/,"$1_="+l);return h+(h===k?(/\?/.test(k)?"&":"?")+"_="+l:"")},param:function(k){return d.param(k,d.ajaxSettings.traditional)},supportStorage:function(){var k=window.localStorage;
if(k)try{return k.setItem("t","t"),k.removeItem("t"),window.StorageEvent&&!d.browser.msie&&!(d.browser.mozilla&&"1"===d.browser.version.split(".")[0])}catch(l){}return!1},iterate:function(d,l){var h;l=l||0;(function P(){h=setTimeout(function(){!1!==d()&&P()},l)})();return function(){clearTimeout(h)}},log:function(d,l){if(window.console){var h=window.console[d];"function"===typeof h&&h.apply(window.console,l)}},warn:function(){d.atmosphere.log("warn",arguments)},info:function(){d.atmosphere.log("info",
arguments)},debug:function(){d.atmosphere.log("debug",arguments)},error:function(){d.atmosphere.log("error",arguments)},isBinary:function(d){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(d))}};(function(){var k,l;d.uaMatch=function(d){d=d.toLowerCase();d=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(d)||0>d.indexOf("compatible")&&
/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];return{browser:d[1]||"",version:d[2]||"0"}};k=d.uaMatch(navigator.userAgent);l={};k.browser&&(l[k.browser]=!0,l.version=k.version);l.chrome?l.webkit=!0:l.webkit&&(l.safari=!0);l.trident&&(l.msie=!0);d.browser=l;d.sub=function(){function h(d,k){return new h.fn.init(d,k)}d.extend(!0,h,this);h.superclass=this;h.fn=h.prototype=this();h.fn.constructor=h;h.sub=this.sub;h.fn.init=function(l,n){n&&n instanceof d&&!(n instanceof h)&&(n=h(n));return d.fn.init.call(this,
l,n,k)};h.fn.init.prototype=h.fn;var k=h(document);return h}})();(function(d){function l(d){return'"'+d.replace(P,function(d){var h=n[d];return"string"===typeof h?h:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function h(d){return 10>d?"0"+d:d}function r(d,k){var n,N,t,m=k[d];t=typeof m;m&&"object"===typeof m&&"function"===typeof m.toJSON&&(m=m.toJSON(d),t=typeof m);switch(t){case "string":return l(m);case "number":return isFinite(m)?String(m):"null";case "boolean":return String(m);
case "object":if(!m)return"null";switch(Object.prototype.toString.call(m)){case "[object Date]":return isFinite(m.valueOf())?'"'+m.getUTCFullYear()+"-"+h(m.getUTCMonth()+1)+"-"+h(m.getUTCDate())+"T"+h(m.getUTCHours())+":"+h(m.getUTCMinutes())+":"+h(m.getUTCSeconds())+'Z"':"null";case "[object Array]":N=m.length;t=[];for(n=0;n<N;n++)t.push(r(n,m)||"null");return"["+t.join(",")+"]";default:t=[];for(n in m)Object.prototype.hasOwnProperty.call(m,n)&&(N=r(n,m))&&t.push(l(n)+":"+N);return"{"+t.join(",")+
"}"}}}var P=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};d.stringifyJSON=function(d){return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):r("",{"":d})}})(d)});